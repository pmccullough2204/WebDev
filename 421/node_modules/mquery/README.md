# mquery

`mquery` is a fluent mongodb query builder designed to run in multiple environments.

[![Build Status](https://travis-ci.org/aheckmann/mquery.svg?branch=master)](https://travis-ci.org/aheckmann/mquery)
[![NPM version](https://badge.fury.io/js/mquery.svg)](http://badge.fury.io/js/mquery)

[![npm](https://nodei.co/npm/mquery.png)](https://www.npmjs.com/package/mquery)

## Features

- fluent query builder api
- custom base query support
- MongoDB 2.4 geoJSON support
- method + option combinations validation
- node.js driver compatibility
- environment detection
- [debug](https://github.com/visionmedia/debug) support
- separated collection implementations for maximum flexibility

## Use

```js
const mongo = require('mongodb');

const client = new mongo.MongoClient(uri);
await client.connect();
// get a collection
const collection = client.collection('artists');

// pass it to the constructor
await mquery(collection).find({...});

// or pass it to the collection method
const docs = await mquery().find({...}).collection(collection);

// or better yet, create a custom query constructor that has it always set
const Artist = mquery(collection).toConstructor();
const docs = await Artist().find(...).where(...);
```

`mquery` requires a collection object to work with. In the example above we just pass the collection object created using the official [MongoDB driver](https://github.com/mongodb/node-mongodb-native).

## Fluent API

- [mquery](#mquery)
  - [Features](#features)
  - [Use](#use)
  - [Fluent API](#fluent-api)
  - [Helpers](#helpers)
    - [find()](#find)
    - [findOne()](#findone)
    - [count()](#count)
    - [findOneAndUpdate()](#findoneandupdate)
        - [findOneAndUpdate() options](#findoneandupdate-options)
    - [findOneAndRemove()](#findoneandremove)
        - [findOneAndRemove() options](#findoneandremove-options)
    - [distinct()](#distinct)
    - [exec()](#exec)
    - [stream()](#stream)
    - [all()](#all)
    - [and()](#and)
    - [box()](#box)
    - [circle()](#circle)
    - [elemMatch()](#elemmatch)
    - [equals()](#equals)
    - [exists()](#exists)
    - [geometry()](#geometry)
    - [gt()](#gt)
    - [gte()](#gte)
    - [in()](#in)
    - [intersects()](#intersects)
    - [lt()](#lt)
    - [lte()](#lte)
    - [maxDistance()](#maxdistance)
    - [mod()](#mod)
    - [ne()](#ne)
    - [nin()](#nin)
    - [nor()](#nor)
    - [near()](#near)
      - [Example](#example)
    - [or()](#or)
    - [polygon()](#polygon)
    - [regex()](#regex)
    - [select()](#select)
        - [String syntax](#string-syntax)
    - [selected()](#selected)
    - [selectedInclusively()](#selectedinclusively)
    - [selectedExclusively()](#selectedexclusively)
    - [size()](#size)
    - [slice()](#slice)
    - [within()](#within)
    - [where()](#where)
    - [$where()](#where-1)
    - [batchSize()](#batchsize)
    - [collation()](#collation)
    - [comment()](#comment)
    - [hint()](#hint)
    - [j()](#j)
    - [limit()](#limit)
    - [maxTime()](#maxtime)
    - [skip()](#skip)
    - [sort()](#sort)
    - [read()](#read)
        - [Preferences:](#preferences)
        - [Preference Tags:](#preference-tags)
    - [readConcern()](#readconcern)
        - [Read Concern Level:](#read-concern-level)
    - [writeConcern()](#writeconcern)
        - [Write Concern:](#write-concern)
    - [slaveOk()](#slaveok)
    - [tailable()](#tailable)
    - [wtimeout()](#wtimeout)
  - [Helpers](#helpers-1)
    - [collection()](#collection)
    - [then()](#then)
    - [merge(object)](#mergeobject)
    - [setOptions(options)](#setoptionsoptions)
        - [setOptions() options](#setoptions-options)
    - [setTraceFunction(func)](#settracefunctionfunc)
    - [mquery.setGlobalTraceFunction(func)](#mquerysetglobaltracefunctionfunc)
    - [mquery.canMerge(conditions)](#mquerycanmergeconditions)
  - [mquery.use$geoWithin](#mqueryusegeowithin)
  - [Custom Base Queries](#custom-base-queries)
  - [Validation](#validation)
  - [Debug support](#debug-support)
  - [General compatibility](#general-compatibility)
      - [ObjectIds](#objectids)
      - [Read Preferences](#read-preferences)
  - [Future goals](#future-goals)
  - [Installation](#installation)
  - [License](#license)

## Helpers

- [collection](#collection)
- [then](#then)
- [merge](#mergeobject)
- [setOptions](#setoptionsoptions)
- [setTraceFunction](#settracefunctionfunc)
- [mquery.setGlobalTraceFunction](#mquerysetglobaltracefunctionfunc)
- [mquery.canMerge](#mquerycanmergeconditions)
- [mquery.use$geoWithin](#mqueryusegeowithin)

### find()

Declares this query a _find_ query. Optionally pass a match clause.

```js
mquery().find()
mquery().find(match)
await mquery().find()
const docs = await mquery().find(match);
assert(Array.isArray(docs));
```

### findOne()

Declares this query a _findOne_ query. Optionally pass a match clause.

```js
mquery().findOne()
mquery().findOne(match)
await mquery().findOne()
const doc = await mquery().findOne(match);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### count()

Declares this query a _count_ query. Optionally pass a match clause.

```js
mquery().count()
mquery().count(match)
await mquery().count()
const number = await mquery().count(match);
console.log('we found %d matching documents', number);
```

### findOneAndUpdate()

Declares this query a _findAndModify_ with update query. Optionally pass a match clause, update document, options.

When executed, the first matching document (if found) is modified according to the update document and passed back.

#### findOneAndUpdate() options

Options are passed to the `setOptions()` method.

- `returnDocument`: string - `'after'` to return the modified document rather than the original. defaults to `'before'`
- `upsert`: boolean - creates the object if it doesn't exist. defaults to false
- `sort`: if multiple docs are found by the match condition, sets the sort order to choose which doc to update

```js
query.findOneAndUpdate()
query.findOneAndUpdate(updateDocument)
query.findOneAndUpdate(match, updateDocument)
query.findOneAndUpdate(match, updateDocument, options)

// the following all execute the command
await query.findOneAndUpdate()
await query.findOneAndUpdate(updateDocument)
await query.findOneAndUpdate(match, updateDocument)
const doc = await await query.findOneAndUpdate(match, updateDocument, options);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### findOneAndRemove()

Declares this query a _findAndModify_ with remove query. Alias of findOneAndDelete.
Optionally pass a match clause, options.

When executed, the first matching document (if found) is modified according to the update document, removed from the collection and passed as a result.

#### findOneAndRemove() options

Options are passed to the `setOptions()` method.

- `sort`: if multiple docs are found by the condition, sets the sort order to choose which doc to modify and remove

```js
A.where().findOneAndDelete()
A.where().findOneAndRemove()
A.where().findOneAndRemove(match)
A.where().findOneAndRemove(match, options)

// the following all execute the command
await A.where().findOneAndRemove()
await A.where().findOneAndRemove(match)
const doc = await A.where().findOneAndRemove(match, options);
if (doc) {
  // the document may not be found
  console.log(doc);
}
```

### distinct()

Declares this query a _distinct_ query. Optionally pass the distinct field, a match clause.

```js
mquery().distinct()
mquery().distinct(match)
mquery().distinct(match, field)
mquery().distinct(field)

// the following all execute the command
await mquery().distinct()
await mquery().distinct(field)
await mquery().distinct(match)
const result = await mquery().distinct(match, field);
console.log(result);
```

### exec()

Executes the query.

```js
const docs = await mquery().findOne().where('route').intersects(polygon).exec()
```

### stream()

Executes the query and returns a stream.

```js
var stream = mquery().find().stream(options);
stream.on('data', cb);
stream.on('close', fn);
```

Note: this only works with `find()` operations.

Note: returns the stream object directly from the node-mongodb-native driver. (currently streams1 type stream). Any options will be passed along to the [driver method](http://mongodb.github.io/node-mongodb-native/api-generated/cursor.html#stream).

---

### all()

Specifies an `$all` query condition

```js
mquery().where('permission').all(['read', 'write'])
```

[MongoDB documentation](http://docs.mongodb.org/manual/reference/operator/all/)

### and()

Specifies arguments for an `$and` condition

```js
mquery().and([{ color: 'green' }, { status: 'ok' }])
```

[MongoDB documentation](http://docs.mongodb.org/manual/reference/operator/and/)

### box()

Specifies a `$box` condition

```js
var lowerLeft = [40.73083, -73.99756]
var upperRight= [40.741404,  -73.988135]

mquery().where('location').within().box(lowerLeft, upperRight)
```

[MongoDB Documentation](http://docs.mongodb.org/manual/reference/operator/box/)

### circle()

Specifies a `$center` or `$centerSphere` condition.

```js
var area = { center: [50, 50], radius: 10, unique: true }
query.where('loc').within().circle(area)
query.circle('loc', area);

// for spherical calculations
var area = { center: [50, 50], radius: 10, unique: true, spherical: true }
query.where('loc').within().circle(area)
query.circle('loc', area);
```

- [MongoDB Documentation - center](http://docs.mongodb.org/manual/reference/operator/center/)
- [MongoDB Documentation - centerSphere](http://docs.mongodb.org/manual/reference/operator/centerSphere/)

### elemMatch()

Specifies an `$elemMatch` condition

```js
query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})

query.elemMatch('comment', function (elem) {
  elem.where('author').equals('autobot');
  elem.where('votes').gte(5);
})
```

[MongoDB Documentation](http://docs.mongodb.org/manual/reference/operator/elemMatch/)

### equals()

Specifies the complementary comparison value for the path specified with `where()`.

```js
mquery().where('age').equals(49);

// is the same as

mquery().where({ 'age': 49 });
```

### exists()

Specifies an `$exists` condition

```js
// { name: { $exists: true }}
mquery().where('name').exists()
mquery().where('name').exists(true)
mquery().exists('name')

// { name: { $exists: false }}
mquery().where('name').exists(false);
mquery().exists('name', false);
```

[MongoDB Documentation](http://docs.mongodb.org/manual/reference/operator/exists/)

### geometry()

Specifies a `$geometry` condition

```js
var polyA = [[[ 10, 20 ], [ 10, 40 ], [ 30, 40 ], [ 30, 20 ]]]
query.where('loc').within().geometry({ type: 'Polygon', coordinates: polyA })

// or
var polyB = [[ 0, 0 ], [ 1, 1 ]]
query.where('loc').within().geometry({ type: 'LineString', coordinates: polyB })

// or
var polyC = [ 0, 0 ]
query.where('loc').within().geometry({ type: 'Point', coordinates: polyC })

// or
query.where('loc').intersects().geometry({ type: 'Point', coordinates: polyC })

// or
query.where('loc').near().geometry({ type: 'Point', coordinates: [3,5] })
```

`geometry()` **must** come after `intersects()`, `within()`, or `near()`.

The `object` argument must contain `type` and `coordinates` properties.

- type `String`
- coordinates `Array`

[MongoDB Documentation](http://docs.mongodb.org/manual/reference/operator/geometry/)

### gt()

Specifies a `$gt` query condition.

```js
mquery().where('clicks').gt(999)
```

[MongoDB Documentation](http://docs.mongodb.org/manual/reference/operator/gt/)

### gte()

Specifies a `$gte` query condition.

[MongoDB Documentation](http://docs.mongodb.org/manual/reference/operator/gte/)

```js
mquery().where('clicks').gte(1000)
```

### in()

Specifies an `$in` query condition.

```j